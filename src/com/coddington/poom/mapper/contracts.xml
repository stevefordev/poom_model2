<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="contracts">

	<select id="selectScoreAndCountByServiceNo" parameterType="int" resultType="com.coddington.poom.util.CamelHashMap">
		SELECT (CASE WHEN count_done > 0 THEN (score_user / count_done * 100) ELSE 0 END) score_taker, 
		       (CASE WHEN count_done > 0 THEN ((score_price + score_kind + score_knowhow + score_honest) / (4 * count_done) * 100) ELSE 0 END) score_giver,
		       (CASE WHEN count_done > 0 THEN (score_price / count_done * 100) ELSE 0 END) score_price, 
		       (CASE WHEN count_done > 0 THEN (score_kind  / count_done * 100) ELSE 0 END) score_kind, 
		       (CASE WHEN count_done > 0 THEN (score_knowhow / count_done * 100) ELSE 0 END) score_knowhow, 
		       (CASE WHEN count_done > 0 THEN (score_honest / count_done * 100) ELSE 0 END) score_honest,        
		        count_wait, 
		        count_progress, 
		        count_denied, 
		        count_stop, 
		        count_done
		FROM(SELECT
		    COUNT(CASE WHEN c.status = 9 AND c.score_user = 1 THEN 1 END) AS score_user,
		    COUNT(CASE WHEN c.status = 9 AND c.score_price = 1 THEN 1 END) AS score_price,
		    COUNT(CASE WHEN c.status = 9 AND c.score_kind = 1 THEN 1 END) AS score_kind,
		    COUNT(CASE WHEN c.status = 9 AND c.score_knowhow = 1 THEN 1 END) AS score_knowhow,
		    COUNT(CASE WHEN c.status = 9 AND c.score_honest = 1 THEN 1 END) AS score_honest,
		    COUNT(CASE WHEN c.status = 0 THEN 1 END) count_wait,
		    COUNT(CASE WHEN c.status = 1 THEN 1 END) count_progress,
		    COUNT(CASE WHEN c.status = 4 THEN 1 END) count_denied,
		    COUNT(CASE WHEN c.status = 5 THEN 1 END) count_stop,
		    COUNT(CASE WHEN c.status = 9 THEN 1 END) count_done
		    FROM 
		    services s, contracts c
		    WHERE s.no = c.SERVICE_NO
		    AND s.no = #{s.no})
	</select>
	
	<insert id="insert" parameterType="Contract">	
		INSERT INTO contracts (no, giver_no, taker_no, service_no, poom, status, content, 
			score_user, score_price, score_kind, score_knowhow, score_honest,
			area1, area2, detail_address1, detail_address2, latitude, longitude, regdate)
		VALUES (contracts_seq.nextval, #{giverNo}, #{takerNo}, #{serviceNo}, #{poom}, 0, #{content},
		0, 0, 0, 0, 0,
		'', '', '', '', '', '', systimestamp)
		<selectKey keyProperty="no" resultType="Integer" order="AFTER">
			SELECT contracts_seq.currval FROM dual
		</selectKey>
	</insert>
 
</mapper>